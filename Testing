# ---------------------------------------------------------
        # C. VALIDATE, CAST & WRITE
        # ---------------------------------------------------------
        if len(df_data.columns) == len(columns):
            # 1. Apply column names first
            df_final = df_data.toDF(*columns)
            
            # 2. FIX: Explicitly Cast Timestamp Column
            # Check if 'timestamp' is in our columns (case insensitive)
            # Adjust 'timestamp' to match your exact column name (e.g. 'Time', 'Date', 'Timestamp')
            for col_name in df_final.columns:
                if col_name.lower() == "timestamp":
                    # Coalesce handles cases where casting fails (bad formats)
                    df_final = df_final.withColumn(col_name, F.col(col_name).cast(TimestampType()))
            
            # Add metadata
            df_final = df_final.withColumn("source_filename", F.lit(file_path.split('/')[-1])) \
                               .withColumn("ingestion_date", F.current_timestamp())

            # 3. Write to Delta
            df_final.write.format("delta") \
                .mode("append") \
                .option("mergeSchema", "true") \
                .save(dest_delta_path)
                
            print(f"    Success: Appended {df_final.count()} rows.")
            
        else:
            print(f"    ERROR: Mismatch! Header has {len(columns)} cols, Data has {len(df_data.columns)} cols.")

    except Exception as e:
        print(f"    CRITICAL FAIL: {e}")
